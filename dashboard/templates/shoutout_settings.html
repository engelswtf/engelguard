{% extends "base.html" %}

{% block title %}Shoutout Settings - EngelGuard{% endblock %}
{% block page_title %}Shoutout Settings{% endblock %}

{% block content %}
<div class="page-header">
    <p class="page-description">Configure shoutout messages, auto-shoutouts on raids, first-time chatter welcomes, and view shoutout history.</p>
</div>

<!-- Shoutout Settings Section -->
<form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> action="{{ url_for('shoutout_settings') }}" id="shoutoutSettingsForm">
<input type="hidden" name="action" value="save_shoutout_settings">

<div class="card">
    <div class="card-header">
        <div class="filter-title">
            <span class="filter-icon">üì¢</span>
            <h3>Shoutout Settings</h3>
        </div>
        <label class="toggle">
            <input type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="card-body">
        <p class="filter-description">Enable or disable shoutout functionality. When enabled, moderators can use !so or !shoutout to give shoutouts.</p>
        
        <div class="filter-settings">
            <!-- Auto-Shoutout on Raids -->
            <div class="form-group toggle-row">
                <div class="toggle-info">
                    <label>Auto-Shoutout on Raids</label>
                    <p class="field-description">Automatically shoutout streamers who raid your channel.</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" name="auto_raid_shoutout" {% if settings.auto_raid_shoutout %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <!-- Custom Shoutout Message -->
            <div class="form-group">
                <label>Shoutout Message</label>
                <p class="field-description">Customize the message sent when shouting out a user.</p>
                <textarea name="message" rows="3" class="alert-message-input" placeholder="Go check out @$(user) at twitch.tv/$(user) - They were last playing $(game)! üíú">{{ settings.message or "Go check out @$(user) at twitch.tv/$(user) - They were last playing $(game)! üíú" }}</textarea>
            </div>
            
            <!-- Variables Reference -->
            <div class="variables-help">
                <span class="variables-label">Available Variables:</span>
                <div class="variable-tags">
                    <span class="variable-tag" data-var="$(user)">$(user)</span>
                    <span class="variable-tag" data-var="$(game)">$(game)</span>
                    <span class="variable-tag" data-var="$(channel)">$(channel)</span>
                </div>
                <p class="variables-desc">
                    <code>$(user)</code> = Target username &nbsp;|&nbsp;
                    <code>$(game)</code> = Last game played &nbsp;|&nbsp;
                    <code>$(channel)</code> = Current channel
                </p>
            </div>
            
            <!-- Cooldown Duration -->
            <div class="form-group">
                <label>Cooldown Duration (seconds)</label>
                <p class="field-description">Minimum time between shoutouts for the same user to prevent spam.</p>
                <input type="number" name="cooldown_seconds" value="{{ settings.cooldown_seconds or 300 }}" min="0" max="3600">
                <small class="form-hint">Default: 300 seconds (5 minutes). Set to 0 to disable cooldown.</small>
            </div>
        </div>
        
        <div class="form-actions-inline">
            <button type="submit" class="btn btn-primary">Save Shoutout Settings</button>
        </div>
    </div>
</div>
</form>

<!-- First-time Chatter Settings Section -->
<div class="filter-section">
    <h2 class="section-title">First-time Chatter Settings</h2>
    
    <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> action="{{ url_for('shoutout_settings') }}" id="welcomeSettingsForm">
    <input type="hidden" name="action" value="save_welcome_settings">
    
    <div class="card">
        <div class="card-header">
            <div class="filter-title">
                <span class="filter-icon">üëã</span>
                <h3>Welcome Messages</h3>
            </div>
            <label class="toggle">
                <input type="checkbox" name="welcome_enabled" {% if welcome_settings.enabled %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="card-body">
            <p class="filter-description">Automatically welcome first-time chatters to your stream.</p>
            
            <div class="filter-settings">
                <!-- Custom Welcome Message -->
                <div class="form-group">
                    <label>Welcome Message</label>
                    <p class="field-description">Message sent when a user chats for the first time in your channel.</p>
                    <textarea name="welcome_message" rows="2" class="alert-message-input" placeholder="Welcome to the stream @$(user)! üëã">{{ welcome_settings.message or "Welcome to the stream @$(user)! üëã" }}</textarea>
                </div>
                
                <!-- Variables Reference -->
                <div class="variables-help">
                    <span class="variables-label">Available Variables:</span>
                    <div class="variable-tags">
                        <span class="variable-tag" data-var="$(user)">$(user)</span>
                    </div>
                    <p class="variables-desc"><code>$(user)</code> = New chatter's username</p>
                </div>
            </div>
            
            <div class="form-actions-inline">
                <button type="submit" class="btn btn-primary">Save Welcome Settings</button>
            </div>
        </div>
    </div>
    </form>
</div>

<!-- Manual Shoutout Section -->
<div class="filter-section">
    <h2 class="section-title">Manual Shoutout</h2>
    
    <div class="card">
        <div class="card-header">
            <div class="filter-title">
                <span class="filter-icon">üé§</span>
                <h3>Send Shoutout</h3>
            </div>
        </div>
        <div class="card-body">
            <p class="filter-description">Manually trigger a shoutout for a user. This will send the shoutout message to chat.</p>
            
            <div class="manual-shoutout-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="shoutoutUsername" placeholder="Enter username to shoutout" autocomplete="off">
                </div>
                <button type="button" class="btn btn-primary" id="sendShoutoutBtn" onclick="sendManualShoutout()">
                    <span>üì¢</span> Send Shoutout
                </button>
            </div>
            <div id="shoutoutResult" class="action-result" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Shoutout History Section -->
<div class="filter-section">
    <h2 class="section-title">Shoutout History</h2>
    
    <div class="card">
        <div class="card-header">
            <div class="filter-title">
                <span class="filter-icon">üìú</span>
                <h3>Recent Shoutouts</h3>
            </div>
        </div>
        <div class="card-body">
            <p class="filter-description">View recent shoutouts given in your channel.</p>
            
            <!-- Filter Controls -->
            <div class="history-filters">
                <div class="form-group">
                    <label>Filter by User</label>
                    <input type="text" id="historyFilterUser" placeholder="Search by username..." oninput="filterHistory()">
                </div>
                <div class="form-group">
                    <label>Show</label>
                    <select id="historyFilterType" onchange="loadShoutoutHistory()">
                        <option value="all">All Shoutouts</option>
                        <option value="manual">Manual Only</option>
                        <option value="raid">Raid Only</option>
                    </select>
                </div>
            </div>
            
            <!-- History Table -->
            <div class="table-container">
                <table class="data-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Target User</th>
                            <th>Shouted By</th>
                            <th>Was Raid?</th>
                            <th>Date/Time</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="4" class="loading-row">Loading shoutout history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="historyPagination">
                <button type="button" class="btn btn-secondary btn-sm" id="prevPageBtn" onclick="changePage(-1)" disabled>
                    ‚Üê Previous
                </button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button type="button" class="btn btn-secondary btn-sm" id="nextPageBtn" onclick="changePage(1)" disabled>
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Page-specific styles */
.filter-section { margin-top: 2rem; }
.section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }

.filter-title { display: flex; align-items: center; gap: 0.5rem; }
.filter-icon { font-size: 1.25rem; }
.filter-title h3 { margin: 0; font-size: 1rem; }
.filter-description { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem; }
.field-description { color: var(--text-secondary); font-size: 0.8rem; margin: 0.25rem 0 0.5rem 0; }

.filter-settings { display: flex; flex-direction: column; gap: 1rem; }

.toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; }
.toggle-info { flex: 1; }
.toggle-info label { margin-bottom: 0.25rem; display: block; font-weight: 500; }
.toggle-info .field-description { margin: 0; }

.form-group { margin-bottom: 0.75rem; }
.form-group label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9rem; }
.form-group input[type="number"] { max-width: 200px; }
.form-hint { display: block; margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-muted); }

.alert-message-input { font-family: 'Consolas', 'Monaco', monospace; resize: vertical; min-height: 60px; }

.variables-help { background: var(--bg-tertiary); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; }
.variables-label { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.5rem; }
.variable-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
.variable-tag { background: var(--accent); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-family: monospace; cursor: pointer; transition: all 0.2s; }
.variable-tag:hover { background: var(--accent-hover); transform: scale(1.05); }
.variables-desc { font-size: 0.75rem; color: var(--text-secondary); margin: 0; }
.variables-desc code { background: var(--bg-secondary); padding: 0.1rem 0.3rem; border-radius: 3px; }

.form-actions-inline { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }

/* Manual Shoutout */
.manual-shoutout-form { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
.manual-shoutout-form .form-group { flex: 1; min-width: 200px; margin-bottom: 0; }
.action-result { margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.9rem; }
.action-result.success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; }
.action-result.error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; }

/* History Table */
.history-filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
.history-filters .form-group { flex: 1; min-width: 150px; max-width: 250px; }

.table-container { overflow-x: auto; margin-bottom: 1rem; }
.data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
.data-table th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
.data-table tbody tr:hover { background: var(--bg-secondary); }
.data-table .loading-row { text-align: center; color: var(--text-muted); padding: 2rem; }
.data-table .empty-row { text-align: center; color: var(--text-muted); padding: 2rem; }

.raid-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
.raid-badge.yes { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
.raid-badge.no { background: var(--bg-tertiary); color: var(--text-muted); }

/* Pagination */
.pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; }
.page-info { font-size: 0.85rem; color: var(--text-secondary); }
.btn-sm { padding: 0.4rem 0.75rem; font-size: 0.85rem; }

@media (max-width: 768px) {
    .manual-shoutout-form { flex-direction: column; }
    .manual-shoutout-form .form-group { max-width: none; }
    .history-filters { flex-direction: column; }
    .history-filters .form-group { max-width: none; }
    .pagination { flex-direction: column; gap: 0.5rem; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// State for pagination
let currentPage = 1;
let totalPages = 1;
const pageSize = 20;
let allHistory = [];

// Load shoutout history on page load
document.addEventListener('DOMContentLoaded', function() {
    loadShoutoutHistory();
});

// Click to insert variable into textarea
document.querySelectorAll('.variable-tag').forEach(tag => {
    tag.addEventListener('click', function() {
        const variable = this.dataset.var;
        const card = this.closest('.card');
        const textarea = card.querySelector('textarea');
        if (textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + variable + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + variable.length;
        }
    });
});

// Load shoutout history from API
async function loadShoutoutHistory() {
    const filterType = document.getElementById('historyFilterType').value;
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '<tr><td colspan="4" class="loading-row">Loading shoutout history...</td></tr>';
    
    try {
        let url = '/api/shoutout/history?limit=100';
        if (filterType === 'raid') {
            url += '&raid_only=true';
        } else if (filterType === 'manual') {
            url += '&manual_only=true';
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            allHistory = data.history || [];
            currentPage = 1;
            filterHistory();
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-row">Failed to load history: ' + (data.error || 'Unknown error') + '</td></tr>';
        }
    } catch (error) {
        console.error('Error loading history:', error);
        tbody.innerHTML = '<tr><td colspan="4" class="empty-row">Error loading shoutout history</td></tr>';
    }
}

// Filter history by username
function filterHistory() {
    const filterText = document.getElementById('historyFilterUser').value.toLowerCase();
    
    let filtered = allHistory;
    if (filterText) {
        filtered = allHistory.filter(item => 
            item.target_user.toLowerCase().includes(filterText) ||
            item.shouted_by.toLowerCase().includes(filterText)
        );
    }
    
    totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;
    
    renderHistory(filtered);
    updatePagination();
}

// Render history table
function renderHistory(history) {
    const tbody = document.getElementById('historyTableBody');
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = history.slice(start, end);
    
    if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-row">No shoutouts found</td></tr>';
        return;
    }
    
    tbody.innerHTML = pageData.map(item => `
        <tr>
            <td><strong>@${escapeHtml(item.target_user)}</strong></td>
            <td>@${escapeHtml(item.shouted_by)}</td>
            <td><span class="raid-badge ${item.was_raid ? 'yes' : 'no'}">${item.was_raid ? 'üéä Raid' : 'Manual'}</span></td>
            <td>${formatDateTime(item.shouted_at)}</td>
        </tr>
    `).join('');
}

// Update pagination controls
function updatePagination() {
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPageBtn').disabled = currentPage <= 1;
    document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
}

// Change page
function changePage(delta) {
    currentPage += delta;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    filterHistory();
}

// Send manual shoutout
async function sendManualShoutout() {
    const username = document.getElementById('shoutoutUsername').value.trim();
    const resultDiv = document.getElementById('shoutoutResult');
    const btn = document.getElementById('sendShoutoutBtn');
    
    if (!username) {
        resultDiv.className = 'action-result error';
        resultDiv.textContent = 'Please enter a username';
        resultDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> Sending...';
    
    try {
        const response = await fetch('/api/shoutout/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.className = 'action-result success';
            resultDiv.textContent = `‚úì Shoutout sent for @${username}!`;
            document.getElementById('shoutoutUsername').value = '';
            // Reload history to show the new shoutout
            setTimeout(loadShoutoutHistory, 1000);
        } else {
            resultDiv.className = 'action-result error';
            resultDiv.textContent = '‚úó ' + (data.error || 'Failed to send shoutout');
        }
    } catch (error) {
        console.error('Error sending shoutout:', error);
        resultDiv.className = 'action-result error';
        resultDiv.textContent = '‚úó Error sending shoutout. Please try again.';
    } finally {
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<span>üì¢</span> Send Shoutout';
    }
}

// Helper: Format date/time
function formatDateTime(isoString) {
    if (!isoString) return 'Unknown';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Helper: Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Allow Enter key to send shoutout
document.getElementById('shoutoutUsername').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendManualShoutout();
    }
});
</script>
{% endblock %}
