{% extends "base.html" %}

{% block title %}Quotes - EngelGuard{% endblock %}
{% block page_title %}Quotes{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-info">
        <p class="header-subtitle">Manage memorable quotes from your stream</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            + Add Quote
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-row">
    <div class="stat-card">
        <span class="stat-value">{{ quotes|length }}</span>
        <span class="stat-label">Total Quotes</span>
    </div>
</div>

<!-- Quotes Table -->
<div class="card">
    <div class="card-header">
        <h2>All Quotes</h2>
        <div class="card-actions">
            <input type="text" id="searchQuotes" placeholder="Search quotes..." class="search-input" onkeyup="filterQuotes()">
        </div>
    </div>
    <div class="card-body">
        {% if quotes %}
        <table class="data-table" id="quotesTable">
            <thead>
                <tr>
                    <th width="60">ID</th>
                    <th>Quote</th>
                    <th width="120">Author</th>
                    <th width="120">Game</th>
                    <th width="100">Added By</th>
                    <th width="140">Date</th>
                    <th width="100">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for quote in quotes %}
                <tr data-id="{{ quote.id }}">
                    <td><span class="badge badge-secondary">#{{ quote.id }}</span></td>
                    <td class="quote-text">"{{ quote.quote_text }}"</td>
                    <td>{{ quote.author or 'Unknown' }}</td>
                    <td>{{ quote.game or '-' }}</td>
                    <td>{{ quote.added_by }}</td>
                    <td>{{ quote.added_at[:10] if quote.added_at else '-' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="editQuote({{ quote.id }})" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteQuote({{ quote.id }})" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <span class="empty-icon">üìù</span>
            <h3>No quotes yet</h3>
            <p>Add your first quote using the button above or <code>!addquote</code> in chat</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Quote Modal -->
<div class="modal" id="quoteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Quote</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> id="quoteForm">
            <input type="hidden" name="action" id="formAction" value="add">
            <input type="hidden" name="quote_id" id="quoteId" value="">
            
            <div class="form-group">
                <label for="quote_text">Quote Text *</label>
                <textarea id="quote_text" name="quote_text" rows="3" required 
                          placeholder="Enter the quote text..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" name="author" placeholder="Who said it?">
                </div>
                <div class="form-group">
                    <label for="game">Game</label>
                    <input type="text" id="game" name="game" placeholder="What game was being played?">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Quote</button>
            </div>
        </form>
    </div>
</div>

<style>
.quote-text {
    font-style: italic;
    max-width: 400px;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.search-input {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    width: 250px;
}
</style>

<script>
function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Add Quote';
    document.getElementById('formAction').value = 'add';
    document.getElementById('quoteId').value = '';
    document.getElementById('quoteForm').reset();
    document.getElementById('quoteModal').classList.add('active');
}

function editQuote(id) {
    fetch(`/api/quote/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const quote = data.quote;
                document.getElementById('modalTitle').textContent = 'Edit Quote';
                document.getElementById('formAction').value = 'edit';
                document.getElementById('quoteId').value = id;
                document.getElementById('quote_text').value = quote.quote_text;
                document.getElementById('author').value = quote.author || '';
                document.getElementById('game').value = quote.game || '';
                document.getElementById('quoteModal').classList.add('active');
            }
        });
}

function deleteQuote(id) {
    if (confirm('Are you sure you want to delete this quote?')) {
        fetch(`/api/quote/${id}/delete`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`tr[data-id="${id}"]`).remove();
                } else {
                    alert('Failed to delete quote: ' + data.error);
                }
            });
    }
}

function closeModal() {
    document.getElementById('quoteModal').classList.remove('active');
}

function filterQuotes() {
    const search = document.getElementById('searchQuotes').value.toLowerCase();
    const rows = document.querySelectorAll('#quotesTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});

// Close modal on backdrop click
document.getElementById('quoteModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});
</script>
{% endblock %}
